name: CI - Secret scan

on:
  pull_request:
  push:
  workflow_dispatch: {}

jobs:
  secret-scan:
    name: Secret scan (rg targeted)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get update -y && sudo apt-get install -y ripgrep || true

      - name: Run secret scan
        id: scan
        run: |
          set -euo pipefail
          mkdir -p secret-scan
          REPORT=secret-scan/report.txt
          echo "Scanning repository for likely secrets (private keys, long opaque tokens, AWS keys)..."

          # Exclude benign directories and example files to avoid noisy matches (docs, UI labels, artifacts)
          EXCLUDES=("!docs/**" "!dashboard/**" "!widget/**" "!artifacts/**" "!baselines/**" "!tmp_artifacts/**" "!server/.env.example" "!server/.env.secrets.example")

          # Patterns to detect:
          PATTERNS='AKIA[0-9A-Z]{16}|-----BEGIN (PRIVATE|RSA|OPENSSH) KEY-----|[A-Za-z0-9/+]{40,}={0,2}|[a-f0-9]{32,}'

          if command -v rg >/dev/null 2>&1 ; then
            rg -n --hidden --no-ignore -S ${EXCLUDES[@]/#/--glob } -e "$PATTERNS" . > $REPORT || true
          else
            grep -RIn --exclude-dir=.git -E "$PATTERNS" . > $REPORT || true
            for p in docs dashboard widget artifacts baselines tmp_artifacts; do
              sed -i "/^\.\/${p//\//\\/}\//d" $REPORT || true
            done
          fi

          if [ -s "$REPORT" ]; then
            echo "Found potential secrets:"; cat "$REPORT"; exit 1
          else
            echo "No obvious secret literals found"
          fi

      - name: Upload secret-scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: secret-scan/
