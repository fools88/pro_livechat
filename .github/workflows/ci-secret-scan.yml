name: CI - Secret scan

on:
  pull_request:
  push:
  workflow_dispatch: {}
  # Scheduled weekly run to catch secrets that slip in between PRs
  schedule:
    - cron: '0 3 * * 1'

jobs:
  secret-scan:
    name: Secret scan (rg targeted)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get update -y && sudo apt-get install -y ripgrep || true

      - name: Run secret scan
        id: scan
        run: |
          set -euo pipefail
          mkdir -p secret-scan
          REPORT=secret-scan/report.txt
          echo "Scanning repository for likely secrets (private keys, long opaque tokens, AWS keys)..."

          # Defensive: unset any runner-injected http.extraheader which can contain auth headers
          git config --local --unset-all http.extraheader || true

          # Prefer scanning tracked files only to avoid scanning .git metadata and runner checkout headers
          FILES_Z=$(git ls-files -z || true)

          # Explicit excludes to reduce noise (package-lock integrity hashes, artifacts, docs, bundles)
          GLOBS=("!.git/**" "!**/package-lock.json" "!docs/**" "!dashboard/**" "!widget/**" "!artifacts/**" "!baselines/**" "!tmp_artifacts/**" "!server/.env.example" "!server/.env.secrets.example")

          # Tighter patterns to reduce false positives:
          # - GitHub token prefixes (ghp_/ghs_/gho_/ghu_)
          # - AWS access key id (AKIA...)
          # - Google API key (AIza...)
          # - PEM/RSA/OpenSSH private key headers
          # - Long base64-like strings (raise minimum length to 80 to avoid integrity hashes)
          PATTERNS='(ghp_[A-Za-z0-9_\\-]{36,}|ghs_[A-Za-z0-9_\\-]{36,}|gho_[A-Za-z0-9_\\-]{36,}|ghu_[A-Za-z0-9_\\-]{36,}|AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z_\\-]{35,}|-----BEGIN (PRIVATE|RSA|OPENSSH) KEY-----|[A-Za-z0-9+/]{80,}={0,2})'

          if command -v rg >/dev/null 2>&1 ; then
            # Build --glob args for ripgrep from GLOBS
            GLOB_ARGS=()
            for g in "${GLOBS[@]}"; do
              GLOB_ARGS+=("--glob" "$g")
            done

            if [ -n "$FILES_Z" ]; then
              # Use git-tracked files only (safer and avoids .git/ and runner headers)
              printf "%s" "$FILES_Z" | xargs -0 rg -n -S "${GLOB_ARGS[@]}" -e "$PATTERNS" --null --no-ignore-vcs --hidden 2>/dev/null | sed 's/\x0/\n/g' > $REPORT || true
            else
              # Fallback: scan workspace but apply globs
              rg -n -S "${GLOB_ARGS[@]}" -e "$PATTERNS" . > $REPORT || true
            fi
          else
            # Grep fallback: restrict to git ls-files and apply excludes by filtering
            if [ -n "$FILES_Z" ]; then
              git ls-files -z | xargs -0 grep -n -E "$PATTERNS" > $REPORT || true
            else
              grep -RIn --exclude-dir=.git -E "$PATTERNS" . > $REPORT || true
            fi
            # Remove common noisy folders if present
            for p in docs dashboard widget artifacts baselines tmp_artifacts; do
              sed -i "/^\.\/${p//\//\\/}\//d" $REPORT || true
            done
            # Remove package-lock integrity lines if they slipped through
            sed -i -E "/package-lock\.json:.*integrity/d" $REPORT || true
          fi

          if [ -s "$REPORT" ]; then
            echo "Found potential secrets:"; cat "$REPORT"; exit 1
          else
            echo "No obvious secret literals found"
          fi

      - name: Upload secret-scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: secret-scan/
